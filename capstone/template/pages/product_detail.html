{% extends "main_layout.html" %}
{% load static %}
{% block title %}
  {{
  product.title }}
{% endblock title %}
{% block style %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous" />
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
        rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/product_detail.css' %}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Add Chart.js -->
{% endblock style %}
{% block body %}
  <div class="container">
    <a href="{% url 'dashboard' %}" class="back-button">
      <button type="button" class="btn btn-link">Back</button>
    </a>
    <div class="row">
      <!-- Main Content Section (Product Details) -->
      <div class="col-md-7">
        <div class="details-box">
          <h1>{{ product.title }}</h1>
          <!-- Product Information Section -->
          <h3>
            Reference ID: <span>{{ product.ref_id }}</span>
          </h3>
          <h3>
            Brand: <span>{{ product.brand }}</span>
          </h3>
          <h3>
            Manufacturer: <span>{{ product.manufacture }}</span>
          </h3>
          <h3>
            Categories: <span>{{ product.categories }}</span>
          </h3>
          <!-- <h3>Total Ratings: <span>{{ product.rating_count }}</span></h3>
          <h3>Average Ratings: <span>{{ product.avg_rating }}</span></h3>
<h3>Recommend Count: <span>{{ product.recommend_count }}</span></h3> -->
          <!-- AI Generated Summary Section -->
          <div class="details-box">
            <h3>AI Generated Summary</h3>
            <p>{{ product.review_summary }}</p>
          </div>
          <a href="{% url 'product_edit' pk=product.pk %}" class="btn btn-primary">Edit</a>
        </div>
      </div>
      <!-- Chart Section -->
      <div class="col-md-5">
        <div class="row">
          <div class="col-md-11">
            <div class="chart-container">
              <h2>Product Ratings Overview</h2>
              <canvas id="ratingsBarChart" width="300" height="200"></canvas>
              <!-- Bar Chart for Ratings -->
            </div>
          </div>
          <div class="col-md-9">
            <div class="chart-container">
              <h2>Recommendation Overview</h2>
              <canvas id="recommendPieChart" width="300" height="100"></canvas>
              <!-- Pie Chart for Recommendations -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- <hr /> -->
  </div>
  <div class="reviews-box">
    <h3>Reviews</h3>
    {% if reviews %}
      {% for review in reviews %}
        <div class="review-box">
          <h4>{{ review.title }}</h4>
          <!-- Star Rating Section -->
          <p>
            <strong>Rating:</strong>
            <span class="star-rating"
                  id="star-rating-{{ forloop.counter }}"
                  data-rating="{{ review.rating }}">
              <!-- JavaScript will dynamically fill this section -->
            </span>
            ({{ review.rating }}/5)
          </p>
          <!-- Review Text Section -->
          <p>
            <strong>Review Text:</strong> {{ review.text }}
          </p>
          <p>
            <strong>Review by:</strong> {{ review.username }} on {{ review.review_date }}
          </p>
          <p>
            <strong>Sentiment:</strong> {{ review.sentiment }}
          </p>
          <hr />
        </div>
      {% endfor %}
    {% else %}
      <p>No reviews available for this product.</p>
    {% endif %}
  </div>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Loop through each review box and set stars
    const starContainers = document.querySelectorAll(".star-rating");
    starContainers.forEach((container) => {
      const rating = parseInt(container.getAttribute("data-rating"), 10); // Get the rating value
      let starHTML = "";

      // Create filled stars
      for (let i = 1; i <= rating; i++) {
        starHTML += '<i class="material-icons">star</i>';
      }
      // Create empty stars
      for (let i = rating + 1; i <= 5; i++) {
        starHTML += '<i class="material-icons">star_border</i>';
      }

      // Set the star icons to the container
      container.innerHTML = starHTML;
    });
  });
  </script>
  <!-- JavaScript to Create Charts -->
  <script>
  // Bar Chart for Total and Average Ratings
  const ctxBar = document.getElementById('ratingsBarChart').getContext('2d');
  const ratingsBarChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ['Total Ratings', 'Average Ratings','Total Reviews'],
      datasets: [{
        label: 'Ratings Data',
        data: [
          {{ product.rating_count }},
          {{ product.avg_rating }},{{product.reviews_count}}
        ],
        backgroundColor: [
          'rgba(75, 192, 192, 0.5)',
          'rgba(153, 102, 255, 0.5)'
        ],
        borderColor: [
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(tooltipItem) {
              return tooltipItem.label + ': ' + tooltipItem.raw;
            }
          }
        }
      }
    }
  });

  // Pie Chart for Recommendation Count
  const ctxPie = document.getElementById('recommendPieChart').getContext('2d');
  const recommendPieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: ['Recommend', 'Not Recommend'], // Assuming binary data for recommendation
      datasets: [{
        label: 'Recommendation Data',
        data: [
          {{ product.do_recommend_count }},
          {{ product.rating_count|add:"-product.do_recommend_count" }} // Calculate not recommend count
        ],
        backgroundColor: [
          'rgba(255, 159, 64, 0.5)',
          'rgba(255, 99, 132, 0.5)'
        ],
        borderColor: [
          'rgba(255, 159, 64, 1)',
          'rgba(255, 99, 132, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(tooltipItem) {
              return tooltipItem.label + ': ' + tooltipItem.raw;
            }
          }
        }
      }
    }
  });
  </script>
  <style>
  /* Optional additional styling for the chart container */
  .chart-container {
    margin-top: 20px;
    text-align: center;
  }

  .chart-container h2 {
    margin-bottom: 20px;
  }

  /* Optional: Set the max-width for the chart container */
  #ratingsBarChart,
  #recommendPieChart {
    max-width: 100%; /* Ensures it doesn't overflow its container */
  }
  /* Styling for the reviews section */
  .review-box {
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
  }
  .review-box h4 {
    margin-top: 0;
  }
  .reviews-box {
    width: 90%; /* Ensures the details-box takes full width of the container */
    padding: 20px; /* Keep some padding for spacing */
    margin: 0 auto; /* Center the box if the container has limited width */
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .star-rating i {
    color: #ffd700; /* Gold color for the filled stars */
    font-size: 20px; /* Adjust the size as needed */
    margin-right: 2px; /* Small spacing between stars */
  }

  .star-rating .material-icons {
    vertical-align: middle;
  }

  .star-rating .star_border {
    color: #ccc; /* Grey color for the unfilled stars */
  }
  </style>
{% endblock body %}
